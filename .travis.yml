sudo: required
addons:
  apt:
    update: true
    packages:
    - docker-ce
services:
- docker
script:
- export DOCKER_CLI_EXPERIMENTAL=enabled
- source sha_function.sh
- alpine_x86_sha=$(get_manifest_sha  "alpine" "latest" "amd64")
- echo $alpine_x86_sha
- treehouses_alpine_x86_sha=$(get_manifest_sha  "treehouses/alpine" "latest" "amd64")
- echo $treehouses_alpine_x86_sha
- balena_rpi_sha=$(get_tag_sha "balenalib/raspberry-pi-alpine" "latest" )
- echo $balena_rpi_sha
- treehouses_rpi_sha=$(get_treehouses_rpi_sha "treehouses/alpine" "arm")
- echo $treehouses_rpi_sha
- flag=$(compare_sha  "$alpine_x86_sha" "treehouses_alpine_x86_sha" "balena_rpi_sha"
  "treehouses_rpi_sha")
- echo $flag
- echo $DOCKERAPIKEY | docker login -u "sevenseas" --password-stdin
before_deploy:
- tag="3.12-$(date +%Y%m%d%H%M)"
- echo $tag
- create_manifests treehouses/alpine $tag  "alpine@"$alpine_x86_sha "balenalib/raspberry-pi-alpine@"$balena_rpi_sha
- docker manifest inspect treehouses/alpine:latest
- docker manifest inspect treehouses/alpine:$tag
deploy:
- provider: script
  script: docker manifest push treehouses/alpine:latest; docker manifest push treehouses/alpine:$tag
  on:
    all_branches: true
    condition: "$flag"
env:
  global:
  - secure: gOiZ4dJungOLStbEeqFcOJsFzsOimOTj+ZPQdeKNcY23RFcO1fnlPedLI/uokvS32ZsahPa52k2g+aAp4/0MyoFS9Tlf95SYZ+ay2rT/0tAujdWIv63SGlgEhCj7MdQ0CgSss3bQsVKOK6pApzAu9aMDoqmcpYeewzS2/ACRK587rCzt3/rtNDI6vspFOZGlW/RUKBEXC4tdqkB4HC+CGw4MI2G0CV1OJ773ZevLZPRNXqWTQeAhPa/TdEyFkF4ebXNVzqORY+egJ69GN/8w2QTMnlF9soXnKtGUquw0OiyfaJMbxeMQLN0LTi7LjbyjEXRGkU+zyMjnzAZ3JviMQJYjiAOyRAZu/Y4KfG4XiodVgaIg+lB2IDGmDm2WkoGG19iiyhJqDjCUPMTxcZ+0KcFdJ+/dAlJszWHThEWflkd0WR2CSFXghAHGGCsQwQ3fLsKkfFKyNTU1uV+YJySmx2Hk+20HbMxDMsHDpSU0mWdAQB/ZniDdceUR9uDJNBAagy10TGXUzfylVlv+1C+z7KzcvpYuHSlk+150MYDVr5+2nCw+2RJQJrHeVTJeyrD74QXWtxUdcOTjghnr3u20qzVlD+pLpBDQcRqEXOwAyGo2O12uZEt8ZzasPlDTp8eFho/vbCdOQ8UjCSWYnTtiyVO15+zOIQOQ4ZkH5NLVbw0=
