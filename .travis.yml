sudo: required
addons:
  apt:
    update: true
    packages:
    - docker-ce
services:
- docker
script:
- export DOCKER_CLI_EXPERIMENTAL=enabled
- source sha_function.sh
- alpine_x86_sha=$(get_manifest_sha  "alpine" "latest" "amd64")
- treehouses_alpine_x86_sha=$(get_manifest_sha  "treehouses/alpine" "latest" "amd64")
- balena_rpi_sha=$(get_tag_sha "balenalib/raspberry-pi-alpine" "latest" )
- treehouses_rpi_sha=$(get_treehouses_rpi_sha "treehouses/alpine" "arm")
- flag=$(compare_sha  "$alpine_x86_sha" "treehouses_alpine_x86_sha" "balena_rpi_sha" "treehouses_rpi_sha")
#- echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
- echo "1f0c6d77-506a-4ba2-979d-1e7e1ed6a842" | docker login -u "sevenseas" --password-stdin
before_deploy:
- tag="3.12-$(date +%Y%m%d%H%M)"
- echo $tag
- create_manifests treehouses/alpine $tag  "alpine@"$alpine_x86_sha "balenalib/raspberry-pi-alpine@"$balena_rpi_sha
#- create_manifests vmnet8/alpine 3.12-$(date +%Y%m%d%H%M) "alpine@"$alpine_x86_sha "balenalib/raspberry-pi-alpine@"$balena_rpi_sha
- docker manifest inspect treehouses/alpine:latest
- docker manifest inspect treehouses/alpine:$tag
deploy:
- provider: script
  script: docker manifest push treehouses/alpine:latest; docker manifest push treehouses/alpine:$tag
  on:
    all_branches: true
    condition: $flag
env:
  global:
  - secure: R+mSAK87xrYZCtiPbtu2WyiKV900lTnIErn2QtQz2DDz6ed0+dROeQ+yjANiaRgUsclAEsK2cq6E+3IkjOTukZchmth1H4J5MIkRu5a6zb8ZwxBPvjJgcLHYMBiMLp6u8FyyKNPYM86Qc7H/jCc4F0bb/unZGikiHwzdyEMd0wxXs5g/DnUtQanqKKw20yhM8HpzdyYNhR1fx7jwvCuRspmRovTjSqP/zm0S9/RzAl9BpjaI4s9MLX2fSMzELtnZ0nGo1AL6Qc0lFKhaMNdAQ/mhyjgj083cq7PAp4xYZg4QClXoCOAEgaKzb9mkiAE741+5LV79a1dHyxo3z5/Qry/ZlUrOIJ8IIZ8nU3h6zA9A0nJbYW2u1/2dLlf2pIphM+TUE3MTuE5hvEZd4mTLl7Cf9NDKVA3aI4v6zGD57AjM+Zi3+lGU85cOGBQO8kYjR1VRfVQX1OKQKbpCKj+h5d86xEdWlshY4cZb0MK1Xy1zJgTwqX6AEOQJ3N8J3c4DBYNTN4pP9rdaN7h/q+47kldsdYJlSK72IqedVPOloGpzBo3n67BlIkSYG47UMJgzDxgPjK/lzosMWLjBFGUxgkPXswPulFWEWR0+qK5663k/6Wv3/mke4X7hWtXMM9zH0xFvqxSr8fakMiRySml14pgbEKsz4vDF2C7XaALBJjc=
